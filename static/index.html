<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy IA - Suporte Técnico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .chat-bubble {
            max-width: 80%;
            white-space: pre-wrap;
            /* Importante para mostrar as quebras de linha */
            word-wrap: break-word;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Ajuste para o textarea parecer o input original */
        textarea {
            resize: none;
            min-height: 48px;
            /* Altura original do seu input */
            max-height: 120px;
            overflow-y: hidden;
        }
    </style>
</head>

<body class="bg-gray-50 h-screen flex flex-col">

    <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between z-10">
        <div class="flex items-center gap-3">
            <div
                class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
                A</div>
            <div>
                <h1 class="font-semibold text-gray-800">Academy IA</h1>
                <p class="text-xs text-green-500 font-medium flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span> Online
                </p>
            </div>
        </div>
    </header>

    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide">
        <div class="flex justify-start">
            <div
                class="chat-bubble bg-white border border-gray-200 text-gray-700 rounded-2xl rounded-tl-none px-4 py-3 shadow-sm">
                Olá! Eu sou o seu assistente de IA da CWS Platform, pronto para responder às suas perguntas. Como posso
                ajudar você hoje?
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-100 p-4">
        <form id="chat-form" class="max-w-4xl mx-auto flex gap-2 items-end">
            <textarea id="user-input" rows="1"
                class="flex-1 bg-gray-100 border-0 rounded-3xl px-6 py-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all scrollbar-hide"
                placeholder="Digite sua dúvida... (Shift+Enter pula linha)" required></textarea>

            <button type="submit"
                class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full p-3 w-12 h-12 flex items-center justify-center transition-colors shadow-md flex-shrink-0 mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
            </button>
        </form>
        <div class="text-center mt-2">
            <a href="/admin" class="text-xs text-gray-400 hover:text-gray-600 transition-colors">Acesso Admin</a>
        </div>
    </footer>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');

        // Lógica para Auto-Resize e Shift+Enter
        userInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if (this.value === '') this.style.height = 'auto';
        });

        userInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Impede a quebra de linha padrão
                if (userInput.value.trim() !== "") {
                    // Dispara o evento de submit manualmente
                    const event = new Event('submit', { cancelable: true });
                    chatForm.dispatchEvent(event);
                }
            }
        });

        function appendMessage(text, isUser) {
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            // Adicionado 'whitespace-pre-wrap' via CSS inline no style lá em cima para respeitar quebras de linha
            bubble.className = `chat-bubble px-4 py-3 shadow-sm ${isUser
                ? 'bg-indigo-600 text-white rounded-2xl rounded-tr-none'
                : 'bg-white border border-gray-200 text-gray-700 rounded-2xl rounded-tl-none'
                }`;

            // Usando textContent para segurança, mas o CSS white-space vai tratar os \n
            bubble.textContent = text;

            div.appendChild(bubble);
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return;

            appendMessage(message, true);

            // Reseta o input
            userInput.value = '';
            userInput.style.height = 'auto'; // Reseta altura
            userInput.focus();

            // Show loading state
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = '<div class="chat-bubble bg-white border border-gray-200 text-gray-400 rounded-2xl rounded-tl-none px-4 py-3 shadow-sm">Digitando...</div>';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                chatContainer.removeChild(loadingDiv); // Remove loading
                appendMessage(data.response, false);
            } catch (error) {
                chatContainer.removeChild(loadingDiv);
                appendMessage("Erro ao conectar com o servidor.", false);
                console.error(error);
            }
        });
    </script>
</body>

</html>